<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz Builder & Grader</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #14141c;
      --surface-2: #1a1a25;
      --surface-hover: #20202e;
      --border: #2a2a3a;
      --text: #e8e8f0;
      --text-muted: #7878a0;
      --accent: #7c5cff;
      --accent-hover: #9278ff;
      --accent-glow: rgba(124, 92, 255, 0.4);
      --accent2: #5ce1ff;
      --correct: #22c55e;
      --wrong: #ef4444;
      --radius: 16px;
      --radius-sm: 10px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* Animated background orbs */
    .bg-glow {
      position: fixed;
      border-radius: 50%;
      filter: blur(120px);
      pointer-events: none;
      z-index: 0;
    }
    .bg-glow.orb1 {
      width: 500px; height: 500px;
      background: radial-gradient(circle, rgba(124,92,255,0.18), transparent 70%);
      top: -10%; left: -10%;
      animation: float1 12s ease-in-out infinite;
    }
    .bg-glow.orb2 {
      width: 400px; height: 400px;
      background: radial-gradient(circle, rgba(92,225,255,0.1), transparent 70%);
      bottom: -15%; right: -10%;
      animation: float2 15s ease-in-out infinite;
    }
    .bg-glow.orb3 {
      width: 300px; height: 300px;
      background: radial-gradient(circle, rgba(124,92,255,0.08), transparent 70%);
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      animation: float3 10s ease-in-out infinite;
    }
    @keyframes float1 { 0%,100% { transform: translate(0,0); } 50% { transform: translate(60px,40px); } }
    @keyframes float2 { 0%,100% { transform: translate(0,0); } 50% { transform: translate(-50px,-30px); } }
    @keyframes float3 { 0%,100% { transform: translate(-50%,-50%) scale(1); } 50% { transform: translate(-50%,-50%) scale(1.3); } }

    /* Grid pattern overlay */
    .grid-overlay {
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
      background-size: 60px 60px;
      pointer-events: none;
      z-index: 0;
    }

    .app {
      max-width: 660px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
      position: relative;
      z-index: 1;
      animation: fadeUp 0.6s ease-out;
    }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, var(--text) 0%, var(--accent) 50%, var(--accent2) 100%);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 6s ease infinite;
    }
    @keyframes gradientShift {
      0%,100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .subtitle { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 2rem; }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 1.25rem;
      padding: 0.4rem 0.9rem;
      color: var(--text-muted);
      font-size: 0.85rem;
      font-weight: 500;
      text-decoration: none;
      border: 1px solid var(--border);
      border-radius: 100px;
      transition: all 0.3s;
    }
    .back-link:hover {
      color: var(--text);
      border-color: var(--accent);
      background: rgba(124,92,255,0.06);
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.75rem;
      background: var(--surface);
      padding: 0.3rem;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }
    .tab {
      flex: 1;
      padding: 0.7rem 1rem;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: all 0.25s;
    }
    .tab:hover { color: var(--text); }
    .tab.active {
      background: linear-gradient(135deg, var(--accent), #6644dd);
      color: white;
      box-shadow: 0 4px 16px rgba(124,92,255,0.3);
    }

    .panel { display: none; }
    .panel.active { display: block; }

    .question-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .question-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      opacity: 0;
      transition: opacity 0.3s;
    }
    .question-card:hover::before { opacity: 1; }
    .question-card:hover {
      border-color: rgba(124,92,255,0.3);
      box-shadow: 0 4px 20px rgba(124,92,255,0.08);
    }
    .question-card h3 { font-size: 0.8rem; font-weight: 600; color: var(--accent); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .question-card .q-explanation { margin-top: 0.75rem; min-height: 2.5rem; font-size: 0.88rem; }

    input[type="text"], textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
      margin-bottom: 0.75rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124, 92, 255, 0.15);
    }
    textarea { min-height: 80px; resize: vertical; }

    .option-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
    .option-row input[type="text"] { flex: 1; margin-bottom: 0; }
    .option-row input[type="radio"] { accent-color: var(--accent); width: 18px; height: 18px; cursor: pointer; }

    .btn {
      padding: 0.65rem 1.25rem;
      border: none;
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #6644dd);
      color: white;
      box-shadow: 0 2px 12px rgba(124,92,255,0.25);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, var(--accent-hover), #7755ee);
      box-shadow: 0 4px 20px rgba(124,92,255,0.35);
      transform: translateY(-1px);
    }
    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid var(--border);
    }
    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; margin-top: 0; }
    .result-filter-btn.active { background: rgba(124,92,255,0.15); color: var(--accent); border-color: var(--accent); }
    .btn-ghost:hover {
      background: var(--surface-hover);
      color: var(--text);
      border-color: rgba(124,92,255,0.3);
    }
    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--wrong);
      border: 1px solid rgba(239,68,68,0.2);
    }
    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239,68,68,0.4);
    }

    .add-question {
      margin-top: 1rem;
      width: 100%;
      padding: 0.85rem;
      border: 2px dashed var(--border);
      background: transparent;
      color: var(--text-muted);
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s;
    }
    .add-question:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(124,92,255,0.04);
    }

    .card-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 0.75rem; }

    .quiz-progress { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; }

    .quiz-question {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: border-color 0.3s;
    }
    .quiz-question:hover { border-color: rgba(124,92,255,0.2); }
    .quiz-question h2 { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; line-height: 1.4; }

    .quiz-option {
      display: block;
      width: 100%;
      padding: 1rem 1.25rem;
      margin-bottom: 0.5rem;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      transition: all 0.25s;
    }
    .quiz-option:hover {
      border-color: var(--accent);
      background: var(--surface-hover);
      transform: translateX(4px);
    }
    .quiz-option.selected {
      border-color: var(--accent);
      background: rgba(124, 92, 255, 0.12);
      box-shadow: 0 0 0 1px var(--accent), 0 2px 12px rgba(124,92,255,0.15);
    }

    .finish-row { margin-top: 1.5rem; display: flex; justify-content: center; }
    .finish-btn {
      padding: 0.9rem 2.5rem;
      font-size: 1rem;
      background: linear-gradient(135deg, var(--accent), var(--accent2)) !important;
      box-shadow: 0 4px 24px rgba(124,92,255,0.3) !important;
    }
    .finish-btn:hover {
      box-shadow: 0 6px 32px rgba(124,92,255,0.45) !important;
      transform: translateY(-2px);
    }

    .results-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    .results-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }
    .score-big {
      font-size: 3rem;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 0.25rem;
      margin-top: 0.5rem;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .score-label { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem; }

    .result-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    .result-item:last-child { border-bottom: none; }
    .result-icon {
      flex-shrink: 0;
      width: 26px; height: 26px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .result-icon.correct { background: rgba(34, 197, 94, 0.15); color: var(--correct); }
    .result-icon.wrong { background: rgba(239, 68, 68, 0.15); color: var(--wrong); }
    .result-text { flex: 1; }
    .result-text strong { display: block; margin-bottom: 0.25rem; }
    .result-text span { color: var(--text); font-size: 0.9rem; }
    .explanation-block { margin-top: 0.5rem; }
    .explanation-toggle { background: none; border: none; color: var(--accent); font-size: 0.85rem; cursor: pointer; padding: 0.25rem 0; font-family: inherit; text-decoration: underline; text-underline-offset: 2px; }
    .explanation-toggle:hover { color: var(--accent-hover); }
    .result-explanation { margin-top: 0.5rem; padding: 0.6rem 0.75rem; background: rgba(124,92,255,0.08); border-left: 3px solid var(--accent); border-radius: 0 6px 6px 0; font-size: 0.88rem; color: var(--text); line-height: 1.5; }
    .result-explanation ul, .result-explanation ol { margin: 0.4em 0; padding-left: 1.25em; }
    .result-explanation li { margin: 0.2em 0; }

    .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
    .empty-state p { margin-bottom: 1rem; }

    .bulk-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    .bulk-section:hover {
      border-color: rgba(124,92,255,0.2);
      box-shadow: 0 2px 16px rgba(124,92,255,0.06);
    }
    .bulk-section h3 {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 0.5rem;
    }
    .bulk-section .hint { font-size: 0.82rem; color: var(--text-muted); margin-bottom: 0.75rem; line-height: 1.4; }
    .bulk-section textarea { min-height: 120px; margin-bottom: 0.75rem; }
    .bulk-section .btn { margin-right: 0.5rem; margin-bottom: 0.25rem; }

    .share-actions { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .share-actions .file-input { display: none; }

    #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

    /* Footer */
    .builder-footer {
      text-align: center;
      margin-top: 3rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-muted);
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div class="bg-glow orb1"></div>
  <div class="bg-glow orb2"></div>
  <div class="bg-glow orb3"></div>
  <div class="grid-overlay"></div>

  <div class="app">
    <a href="index.html" class="back-link">← Back to home</a>
    <h1>Quiz Builder</h1>
    <p class="subtitle">Add questions, take the quiz, then click Finish to see your score.</p>
    <div class="tabs">
      <button class="tab active" data-tab="build">Build Quiz</button>
      <button class="tab" data-tab="take">Take Quiz</button>
    </div>
    <div id="build-panel" class="panel active">
      <div class="bulk-section">
        <h3>Share quiz</h3>
        <p class="hint">Send the link or file to someone so they can take the same quiz.</p>
        <div class="share-actions">
          <button type="button" class="btn btn-primary" id="copy-link-btn">Copy share link</button>
          <button type="button" class="btn btn-ghost" id="download-btn">Download quiz file</button>
        </div>
      </div>
      <div class="bulk-section">
        <h3>Load shared quiz</h3>
        <p class="hint">Open a quiz someone sent you, or load from a file.</p>
        <div class="share-actions">
          <button type="button" class="btn btn-primary" id="load-file-btn">Open quiz file…</button>
          <input type="file" class="file-input" id="quiz-file-input" accept=".json,application/json">
        </div>
      </div>
      <div class="bulk-section">
        <h3>Bulk import (paste without answers)</h3>
        <p class="hint">For each question: <strong>first line</strong> = question text, <strong>next 4 lines</strong> = options A, B, C, D. Separate questions with a blank line.</p>
        <textarea id="bulk-questions" placeholder="What is 2+2?&#10;3&#10;4&#10;5&#10;6&#10;&#10;Capital of France?&#10;London&#10;Paris&#10;Berlin&#10;Madrid"></textarea>
        <button type="button" class="btn btn-primary" id="import-questions">Import questions</button>
      </div>
      <div class="bulk-section">
        <h3>Paste answer key (after questions are in)</h3>
        <p class="hint">One letter (A–D) per question, in order. e.g. <strong>B D A C</strong></p>
        <textarea id="answer-key" placeholder="B D A C"></textarea>
        <button type="button" class="btn btn-primary" id="apply-answer-key">Apply answer key</button>
      </div>
      <div id="questions-container"></div>
      <button type="button" class="add-question" id="add-question">+ Add question</button>
    </div>
    <div id="take-panel" class="panel">
      <div id="quiz-container">
        <p class="quiz-progress" id="quiz-progress"></p>
        <div id="quiz-questions"></div>
        <div class="finish-row" id="finish-row" style="display: none;">
          <button type="button" class="btn btn-primary finish-btn" id="finish-btn">Finish &amp; grade</button>
        </div>
        <div id="results-container" style="display: none;"></div>
      </div>
      <div id="empty-quiz" class="empty-state" style="display: none;">
        <p>No questions yet. Add some in the Build Quiz tab.</p>
      </div>
    </div>
    <div class="builder-footer">Not affiliated with CompTIA. For study purposes only.</div>
  </div>
  <script>
    let questions = JSON.parse(localStorage.getItem('quiz-questions') || '[]');
    function save() { localStorage.setItem('quiz-questions', JSON.stringify(questions)); }
    function encodeQuizForUrl() { return btoa(unescape(encodeURIComponent(JSON.stringify(questions)))).replace(/\+/g, '-').replace(/\//g, '_'); }
    function decodeQuizFromUrl(str) { try { const base64 = str.replace(/-/g, '+').replace(/_/g, '/'); return JSON.parse(decodeURIComponent(escape(atob(base64)))); } catch (e) { return null; } }
    function loadQuizFromUrl() { const params = new URLSearchParams(window.location.search); const encoded = params.get('quiz'); if (!encoded) return; const loaded = decodeQuizFromUrl(encoded); if (loaded && Array.isArray(loaded) && loaded.length > 0) { questions = loaded; save(); renderBuild(); history.replaceState(null, '', window.location.pathname); } }
    document.getElementById('copy-link-btn').addEventListener('click', () => { const encoded = encodeQuizForUrl(); if (encoded.length > 1800) { alert('Quiz is too long for a link. Use "Download quiz file" instead.'); return; } const url = window.location.origin + window.location.pathname + '?quiz=' + encoded; navigator.clipboard.writeText(url).then(() => alert('Share link copied!')).catch(() => alert('Could not copy. Try "Download quiz file".')); });
    document.getElementById('download-btn').addEventListener('click', () => { const blob = new Blob([JSON.stringify(questions, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'quiz.json'; a.click(); URL.revokeObjectURL(a.href); });
    document.getElementById('load-file-btn').addEventListener('click', () => document.getElementById('quiz-file-input').click());
    document.getElementById('quiz-file-input').addEventListener('change', (e) => { const file = e.target.files && e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = () => { try { const loaded = JSON.parse(reader.result); if (Array.isArray(loaded) && loaded.length > 0) { questions = loaded; save(); renderBuild(); alert('Quiz loaded.'); } else alert('File does not contain a valid quiz.'); } catch (err) { alert('Could not read file.'); } e.target.value = ''; }; reader.readAsText(file); });
    function escapeHtml(str) { if (!str) return ''; const div = document.createElement('div'); div.textContent = str; return div.innerHTML; }
    function formatExplanation(str) {
      if (!str) return '';
      const escaped = escapeHtml(str);
      const lines = escaped.split(/\r?\n/);
      const out = [];
      let inList = false;
      let listType = null;
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const bulletMatch = line.match(/^[\s]*([•\-*▪◦–])\s+(.*)$/) || line.match(/^[\s]*([•\-*])\s*$/);
        const numMatch = line.match(/^[\s]*(\d+)[.)]\s+(.*)$/);
        if (bulletMatch) {
          const content = (bulletMatch[2] || '').trim();
          if (!inList || listType !== 'ul') { if (inList) out.push(listType === 'ol' ? '</ol>' : '</ul>'); out.push('<ul>'); inList = true; listType = 'ul'; }
          out.push('<li>' + content + '</li>');
        } else if (numMatch) {
          const content = numMatch[2].trim();
          if (!inList || listType !== 'ol') { if (inList) out.push(listType === 'ul' ? '</ul>' : '</ol>'); out.push('<ol>'); inList = true; listType = 'ol'; }
          out.push('<li>' + content + '</li>');
        } else {
          if (inList) { out.push(listType === 'ul' ? '</ul>' : '</ol>'); inList = false; listType = null; }
          if (line.trim()) out.push('<p style="margin:0.35em 0">' + line + '</p>');
        }
      }
      if (inList) out.push(listType === 'ul' ? '</ul>' : '</ol>');
      return out.join('').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    }
    function renderBuild() {
      const container = document.getElementById('questions-container'); container.innerHTML = '';
      questions.forEach((q, index) => { const opts = [...(q.options || []), '', '', ''].slice(0, 4); if (opts.length < 4) opts.push(...Array(4 - opts.length).fill('')); const card = document.createElement('div'); card.className = 'question-card'; card.dataset.index = index; card.innerHTML = `<h3>Question ${index + 1}</h3><textarea placeholder="Question text" class="q-text">${escapeHtml(q.text)}</textarea><div class="options-list">${opts.map((opt, i) => `<div class="option-row"><input type="radio" name="correct-${index}" ${i === q.correctIndex ? 'checked' : ''} value="${i}"><input type="text" class="opt-text" placeholder="${'ABCD'[i]})" value="${escapeHtml(opt)}"></div>`).join('')}</div><textarea placeholder="Explanation (optional, shown in results)" class="q-explanation">${escapeHtml(q.explanation || '')}</textarea><div class="card-actions"><button type="button" class="btn btn-danger btn-remove">Remove</button></div>`; container.appendChild(card); });
      container.querySelectorAll('.question-card').forEach(card => { const index = parseInt(card.dataset.index, 10); const textarea = card.querySelector('.q-text'); const explTextarea = card.querySelector('.q-explanation'); const optInputs = card.querySelectorAll('.opt-text'); const radioInputs = card.querySelectorAll('input[type="radio"]'); if (!questions[index].options) questions[index].options = []; while (questions[index].options.length < 4) questions[index].options.push(''); textarea.addEventListener('change', () => { questions[index].text = textarea.value.trim(); save(); }); if (explTextarea) explTextarea.addEventListener('change', () => { questions[index].explanation = explTextarea.value.trim(); save(); }); optInputs.forEach((input, i) => { input.addEventListener('change', () => { questions[index].options[i] = input.value.trim(); save(); }); }); radioInputs.forEach((radio, i) => { radio.addEventListener('change', () => { if (radio.checked) questions[index].correctIndex = i; save(); }); }); card.querySelector('.btn-remove').addEventListener('click', () => { questions.splice(index, 1); save(); renderBuild(); }); });
    }
    document.getElementById('add-question').addEventListener('click', () => { questions.push({ text: '', options: ['', '', '', ''], correctIndex: 0 }); save(); renderBuild(); });
    document.getElementById('import-questions').addEventListener('click', () => { const raw = document.getElementById('bulk-questions').value.trim(); if (!raw) return; const blocks = raw.split(/\n\s*\n/).map(b => b.trim()).filter(Boolean); const imported = []; for (const block of blocks) { const lines = block.split('\n').map(l => l.trim()); imported.push({ text: lines[0] || '', options: [lines[1] ?? '', lines[2] ?? '', lines[3] ?? '', lines[4] ?? ''], correctIndex: 0 }); } questions = imported; save(); renderBuild(); document.getElementById('bulk-questions').value = ''; });
    document.getElementById('apply-answer-key').addEventListener('click', () => { const raw = document.getElementById('answer-key').value.trim().toUpperCase(); const letters = raw.replace(/,/g, ' ').split(/\s+/).filter(Boolean); const map = { A: 0, B: 1, C: 2, D: 3 }; letters.forEach((letter, i) => { if (i < questions.length && letter in map) questions[i].correctIndex = map[letter]; }); save(); renderBuild(); document.getElementById('answer-key').value = ''; });
    document.querySelectorAll('.tab').forEach(tab => { tab.addEventListener('click', () => { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.panel').forEach(p => p.classList.remove('active')); tab.classList.add('active'); document.getElementById(tab.dataset.tab + '-panel').classList.add('active'); if (tab.dataset.tab === 'take') renderTake(); }); });
    let selectedAnswers = {};
    let displayOrder = [];
    function shuffle(arr) { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
    function renderTake() {
      const quizQuestions = document.getElementById('quiz-questions'); const progress = document.getElementById('quiz-progress'); const finishRow = document.getElementById('finish-row'); const resultsContainer = document.getElementById('results-container'); const emptyQuiz = document.getElementById('empty-quiz');
      const validQuestions = questions.filter(q => q.text.trim() && q.options.filter(o => o.trim()).length >= 2);
      displayOrder = shuffle(validQuestions);
      if (displayOrder.length === 0) { quizQuestions.innerHTML = ''; finishRow.style.display = 'none'; resultsContainer.style.display = 'none'; emptyQuiz.style.display = 'block'; return; }
      emptyQuiz.style.display = 'none'; resultsContainer.style.display = 'none'; selectedAnswers = {}; finishRow.style.display = 'flex';
      progress.textContent = displayOrder.length + ' question' + (displayOrder.length !== 1 ? 's' : '');
      quizQuestions.innerHTML = '';
      displayOrder.forEach((q, index) => { const opts = q.options.filter(o => o.trim()); const block = document.createElement('div'); block.className = 'quiz-question'; block.innerHTML = `<h2>${index + 1}. ${escapeHtml(q.text)}</h2>${opts.map((opt, i) => `<button type="button" class="quiz-option" data-q="${index}" data-a="${i}">${escapeHtml(opt)}</button>`).join('')}`; quizQuestions.appendChild(block); });
      quizQuestions.querySelectorAll('.quiz-option').forEach(btn => { btn.addEventListener('click', () => { const qIndex = parseInt(btn.dataset.q, 10); const aIndex = parseInt(btn.dataset.a, 10); selectedAnswers[qIndex] = aIndex; btn.closest('.quiz-question').querySelectorAll('.quiz-option').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }); });
    }
    function launchConfetti() {
      const canvas = document.createElement('canvas');
      canvas.id = 'confetti-canvas';
      document.body.appendChild(canvas);
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const pieces = [];
      const colors = ['#7c5cff','#5ce1ff','#22c55e','#f59e0b','#ef4444','#ec4899','#a855f7','#14b8a6','#fbbf24'];
      for (let i = 0; i < 400; i++) {
        pieces.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          w: Math.random() * 14 + 6,
          h: Math.random() * 10 + 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          vy: Math.random() * 6 + 4,
          vx: (Math.random() - 0.5) * 6,
          rot: Math.random() * 360,
          rv: (Math.random() - 0.5) * 12
        });
      }
      let frames = 0;
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        pieces.forEach(p => {
          p.x += p.vx; p.y += p.vy; p.rot += p.rv;
          p.vy += 0.08;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot * Math.PI / 180);
          ctx.fillStyle = p.color;
          ctx.globalAlpha = Math.max(0, 1 - frames / 180);
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          ctx.restore();
        });
        frames++;
        if (frames < 200) requestAnimationFrame(draw);
        else canvas.remove();
      }
      draw();
      setTimeout(() => {
        const canvas2 = document.createElement('canvas');
        canvas2.id = 'confetti-canvas-2';
        canvas2.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9998;';
        document.body.appendChild(canvas2);
        const ctx2 = canvas2.getContext('2d');
        canvas2.width = window.innerWidth;
        canvas2.height = window.innerHeight;
        const pieces2 = [];
        for (let i = 0; i < 200; i++) {
          pieces2.push({
            x: Math.random() * canvas2.width,
            y: -20,
            w: Math.random() * 12 + 4,
            h: Math.random() * 8 + 3,
            color: colors[Math.floor(Math.random() * colors.length)],
            vy: Math.random() * 5 + 3,
            vx: (Math.random() - 0.5) * 4,
            rot: Math.random() * 360,
            rv: (Math.random() - 0.5) * 10,
            delay: Math.floor(Math.random() * 30)
          });
        }
        let f = 0;
        function draw2() {
          ctx2.clearRect(0, 0, canvas2.width, canvas2.height);
          pieces2.forEach(p => {
            if (f > p.delay) {
              p.x += p.vx; p.y += p.vy; p.rot += p.rv;
              p.vy += 0.06;
              ctx2.save();
              ctx2.translate(p.x, p.y);
              ctx2.rotate(p.rot * Math.PI / 180);
              ctx2.fillStyle = p.color;
              ctx2.globalAlpha = Math.max(0, 1 - (f - p.delay) / 150);
              ctx2.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
              ctx2.restore();
            }
          });
          f++;
          if (f < 180) requestAnimationFrame(draw2);
          else canvas2.remove();
        }
        draw2();
      }, 400);
    }
    document.getElementById('finish-btn').addEventListener('click', () => {
      const validQuestions = questions.filter(q => q.text.trim() && q.options.filter(o => o.trim()).length >= 2);
      const toGrade = displayOrder.length > 0 ? displayOrder : validQuestions;
      let correct = 0; const results = toGrade.map((q, index) => { const opts = q.options.filter(o => o.trim()); const userChoice = selectedAnswers[index]; const isCorrect = userChoice === q.correctIndex; if (isCorrect) correct++; return { text: q.text, correct: isCorrect, userAnswer: userChoice !== undefined ? opts[userChoice] : '(not answered)', correctAnswer: opts[q.correctIndex], explanation: q.explanation }; });
      const score = toGrade.length ? Math.round((correct / toGrade.length) * 100) : 0;
      const passed = score >= 70;
      const resultsContainer = document.getElementById('results-container'); resultsContainer.style.display = 'block';
      resultsContainer.innerHTML = `<div class="results-card"><div class="score-big">${correct}/${toGrade.length}</div><div class="score-label">${score}%</div><div class="result-filter" style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap"><button type="button" class="btn btn-ghost btn-sm result-filter-btn active" data-filter="all">All</button><button type="button" class="btn btn-ghost btn-sm result-filter-btn" data-filter="wrong">Wrong only</button></div><div id="result-items">${results.map(r => `<div class="result-item ${r.correct ? 'result-correct' : 'result-wrong'}"><span class="result-icon ${r.correct ? 'correct' : 'wrong'}">${r.correct ? '✓' : '✕'}</span><div class="result-text"><strong>${escapeHtml(r.text)}</strong><span>Your answer: ${escapeHtml(r.userAnswer)}${!r.correct ? ' — Correct: ' + escapeHtml(r.correctAnswer) : ''}</span>${r.explanation ? '<div class="explanation-block"><button type="button" class="explanation-toggle">Show explanation</button><div class="result-explanation" style="display:none">' + formatExplanation(r.explanation) + '</div></div>' : ''}</div></div>`).join('')}</div></div><div class="finish-row" style="margin-top:1rem"><button type="button" class="btn btn-ghost" id="retake-btn">Take quiz again</button></div>`;
      document.getElementById('quiz-questions').style.display = 'none'; document.getElementById('finish-row').style.display = 'none'; document.getElementById('quiz-progress').textContent = 'Results';
      document.querySelectorAll('.result-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.result-filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const filter = btn.dataset.filter;
          document.querySelectorAll('#result-items .result-item').forEach(el => {
            el.style.display = filter === 'wrong' && el.classList.contains('result-correct') ? 'none' : '';
          });
        });
      });
      if (passed) setTimeout(launchConfetti, 600);
      resultsContainer.querySelector('#retake-btn').addEventListener('click', () => { resultsContainer.style.display = 'none'; resultsContainer.innerHTML = ''; renderTake(); document.getElementById('quiz-questions').style.display = ''; });
    });
    loadQuizFromUrl(); renderBuild();
    document.getElementById('results-container').addEventListener('click', (e) => {
      if (e.target.classList.contains('explanation-toggle')) {
        const block = e.target.closest('.explanation-block');
        const explanation = block.querySelector('.result-explanation');
        const isHidden = explanation.style.display === 'none';
        explanation.style.display = isHidden ? 'block' : 'none';
        e.target.textContent = isHidden ? 'Hide explanation' : 'Show explanation';
      }
    });
  </script>
</body>
</html>
